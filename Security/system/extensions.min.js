Ajax.Request.addMethods({request:function(a){this.url=a;this.method=this.options.method;if(Object.isString(this.options.parameters))this.options.parameters=this.options.parameters.toQueryParams();if(this.options.minified){a=this.url.replace(/\.([^.]*?)$/,".min.$1");if(miniLOL.utils.exists(a))this.url=a}if(this.options.cached===false){this.url+=(this.url.include("?")?"&":"?")+Math.random();this.options.requestHeaders=Object.extend(this.options.requestHeaders||{},{"Cache-Control":"must-revalidate",
Pragma:"no-cache"})}if(this.options.tokenized)this.options.parameters.__token=miniLOL.module.execute("Security",{token:true});a=Object.toQueryString(this.options.parameters);if(!["get","post","head"].include(this.method)){a+=(a?"&":"")+"_method="+this.method;this.method="post"}if(a)if(this.method=="get"||this.method=="head")this.url+=(this.url.include("?")?"&":"?")+a;else if(/Konqueror|Safari|KHTML/.test(navigator.userAgent))a+="&_=";this.parameters=a.toQueryParams();try{var b=new Ajax.Response(this);
this.options.onCreate&&this.options.onCreate(b);Ajax.Responders.dispatch("onCreate",this,b);this.transport.open(this.method.toUpperCase(),this.url,this.options.asynchronous);this.options.asynchronous&&this.respondToReadyState.bind(this).defer(1);this.transport.onreadystatechange=this.onStateChange.bind(this);this.setRequestHeaders();this.body=this.method=="post"?this.options.postBody||a:null;this.transport.send(this.body);!this.options.asynchronous&&this.transport.overrideMimeType&&this.onStateChange()}catch(c){this.dispatchException(c)}}});
